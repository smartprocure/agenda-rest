{"version":3,"file":"./dist/index.js","mappings":"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","sources":["webpack://agenda-rest/webpack/universalModuleDefinition","webpack://agenda-rest/external commonjs \"koa\"","webpack://agenda-rest/external commonjs \"koa-logger\"","webpack://agenda-rest/external commonjs \"koa-router\"","webpack://agenda-rest/external commonjs \"koa-bodyparser\"","webpack://agenda-rest/external commonjs \"pythonic\"","webpack://agenda-rest/external node-commonjs \"querystring\"","webpack://agenda-rest/./src/util.js","webpack://agenda-rest/external node-commonjs \"util\"","webpack://agenda-rest/webpack/bootstrap","webpack://agenda-rest/webpack/runtime/compat get default export","webpack://agenda-rest/webpack/runtime/define property getters","webpack://agenda-rest/webpack/runtime/hasOwnProperty shorthand","webpack://agenda-rest/webpack/runtime/make namespace object","webpack://agenda-rest/external commonjs \"agenda\"","webpack://agenda-rest/external commonjs \"../settings\"","webpack://agenda-rest/external commonjs \"request-promise\"","webpack://agenda-rest/./src/job.js","webpack://agenda-rest/./src/index.js"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"./dist/index\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"./dist/index\"] = factory();\n\telse\n\t\troot[\"./dist/index\"] = factory();\n})(global, () => {\nreturn ","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"koa\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"koa-logger\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"koa-router\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"koa-bodyparser\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"pythonic\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"querystring\");","import Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport Router from \"koa-router\";\nimport bodyParser from \"koa-bodyparser\";\nimport { items } from \"pythonic\";\nimport querystring from \"querystring\";\n\nconst bootstrapKoaApp = () => {\n  const app = new Koa();\n  const router = new Router();\n  app.use(logger());\n  app.use((ctx, next) =>\n    next().catch((error) => {\n      console.dir(error);\n      ctx.body = String(error);\n      ctx.status = error.status || 500;\n    })\n  );\n  app.use(\n    bodyParser({\n      onerror(error, ctx) {\n        ctx.throw(400, `cannot parse request body, ${JSON.stringify(error)}`);\n      },\n    })\n  );\n  app.use(router.routes());\n  return { app, router };\n};\n\nconst isValidDate = (date) =>\n  Object.prototype.toString.call(date) === \"[object Date]\" &&\n  !isNaN(date.getTime());\n\nconst repeatPerKey = (keys = {}) => (count) => (key, fn) => () => {\n  if (!(key in keys)) {\n    keys[key] = 0;\n  }\n\n  if (keys[key] < count) {\n    fn();\n    keys[key]++;\n  }\n};\n\nconst oncePerKey = repeatPerKey()(1);\n\nclass AsyncCounter {\n  constructor(countTimes) {\n    let currentCount = 0;\n    this.countTimes = countTimes;\n    this.ready = new Promise((resolveReady) => {\n      this.finished = new Promise((resolveFinished) => {\n        const count = () => {\n          currentCount++;\n          if (currentCount === countTimes) {\n            resolveFinished();\n          }\n\n          return currentCount;\n        };\n\n        this.count = () => this.ready.then(() => count());\n        resolveReady();\n      });\n    });\n  }\n}\n\n// http://example.com:8888/foo/:param1/:param2\n// =>\n// http://example.com:8888/foo/value1/value2\nconst buildUrlWithParams = ({ url, params }) => {\n  if (url.indexOf(\"/:\") > 0 && params) {\n    const protoDomain = url.slice(0, url.indexOf(\"/:\"));\n    let path = url.slice(url.indexOf(\"/:\"));\n    for (const [key, value] of items(params)) {\n      path = path.replace(`:${key}`, value);\n    }\n\n    return `${protoDomain}${path}`;\n  }\n\n  return url;\n};\n\n// http://example.com/foo\n// =>\n// http://example.com/foo?query1=value1&query2=value2\nconst buildUrlWithQuery = ({ url, query }) => {\n  if (query) {\n    query = querystring.stringify(query);\n    if (query !== \"\") {\n      url += `?${query}`;\n    }\n  }\n\n  return url;\n};\n\nexport {\n  bootstrapKoaApp,\n  isValidDate,\n  oncePerKey,\n  AsyncCounter,\n  buildUrlWithParams,\n  buildUrlWithQuery,\n};\n","module.exports = require(\"util\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"agenda\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"../settings\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"request-promise\");","import rp from \"request-promise\";\nimport settings from \"../settings\";\nimport { isValidDate, buildUrlWithParams, buildUrlWithQuery } from \"./util\";\n\nconst getCheckJobFormatFunction = (jobProperty, defaultJob = {}) => (job) => {\n  if (!job.name || (jobProperty && !job[jobProperty])) {\n    throw new Error(\n      `expected request body to match {name${\n        jobProperty ? `, ${jobProperty}` : \"\"\n      }}`\n    );\n  }\n\n  return { ...defaultJob, ...job };\n};\n\nconst doNotCheck = (job) => job;\n\nconst getAssertFunction = (assertOnCount, errorOnName) => (job, jobs) =>\n  jobs.countDocuments({ name: job.name }).then((count) => {\n    if (!assertOnCount(count)) {\n      throw new Error(errorOnName(job.name));\n    }\n  });\n\nconst jobAssertions = {\n  alreadyExists: getAssertFunction(\n    (count) => count > 0,\n    (name) => `Did not find a job named \"${name}\"`\n  ),\n  notExists: getAssertFunction(\n    (count) => count <= 0,\n    (name) => `A job named \"${name}\" already exist`\n  ),\n  doNotAssert: () => true,\n};\n\nconst defineJob = async (job, jobs, agenda) => {\n  const { name, url, method, callback } = job;\n  agenda.define(name, (job, done) => {\n    const {\n      attrs: { data },\n    } = job;\n    let uri = buildUrlWithParams({ url, params: data.params });\n    uri = buildUrlWithQuery({ url: uri, query: data.query });\n\n    const options = {\n      method: method || \"POST\",\n      uri,\n      body: data.body,\n      headers: data.headers || {},\n      json: true,\n    };\n\n    // Error if no response in timeout\n    Promise.race([\n      new Promise((resolve, reject) =>\n        setTimeout(() => reject(new Error(\"TimeOutError\")), settings.timeout)\n      ),\n      rp(options),\n    ])\n      .catch((err) => {\n        job.fail(`options: ${JSON.stringify(options)} message: ${err.message}`);\n        return { error: err.message };\n      })\n      .then((result) => {\n        if (callback) {\n          return rp({\n            method: callback.method || \"POST\",\n            uri: callback.url,\n            headers: callback.headers || {},\n            body: { data, response: result },\n            json: true,\n          });\n        }\n      })\n      .catch((err) => job.fail(`failure in callback: ${err.message}`))\n      .then(() => done());\n  });\n\n  await jobs\n    .countDocuments({ name })\n    .then((count) =>\n      count < 1 ? jobs.insertOne(job) : jobs.updateOne({ name }, { $set: job })\n    );\n\n  return \"job defined\";\n};\n\nconst deleteJob = async (job, jobs, agenda) => {\n  const numRemoved = await agenda.cancel(job);\n  const obj = await jobs.remove(job);\n  return `removed ${obj.result.n} job definitions and ${numRemoved} job instances.`;\n};\n\nconst cancelJob = async (job, jobs, agenda) => {\n  const numRemoved = await agenda.cancel(job);\n  return `${numRemoved} jobs canceled`;\n};\n\nconst getDefaultJobForSchedule = () => ({\n  data: {\n    body: {},\n    params: {},\n    query: {},\n  },\n});\n\nconst pickValues = ({ obj, pickProps }) =>\n  pickProps.reduce(\n    (props, prop) => (obj[prop] ? [...props, obj[prop]] : props),\n    []\n  );\nconst scheduleTypes = {\n  now: {\n    fn: (agenda) => agenda.now.bind(agenda),\n    message: \"for now\",\n    getParams: (job) => pickValues({ obj: job, pickProps: [\"name\", \"data\"] }),\n  },\n  once: {\n    fn: (agenda) => agenda.schedule.bind(agenda),\n    message: \"for once\",\n    getParams: (job) => {\n      // Check if interval is timestamp\n      let time = parseInt(job.interval, 10);\n      time = isNaN(time) ? job.interval : time;\n      // Check if interval is date\n      time = new Date(time);\n      time = isValidDate(time) ? time : job.interval;\n      return pickValues({\n        obj: { ...job, time },\n        pickProps: [\"time\", \"name\", \"data\"],\n      });\n    },\n  },\n  every: {\n    fn: (agenda) => agenda.every.bind(agenda),\n    message: \"for repetition\",\n    getParams: (job) =>\n      pickValues({\n        obj: job,\n        pickProps: [\"interval\", \"name\", \"data\", \"options\"],\n      }),\n  },\n};\n\nconst getScheduleJobFunction = (scheduleType) => async (job, jobs, agenda) => {\n  await scheduleType.fn(agenda)(...scheduleType.getParams(job));\n  return `job scheduled ${scheduleType.message}`;\n};\n\nconst getJobOperation = (checkFunction, jobFunction) => ({\n  check: checkFunction,\n  fn: jobFunction,\n});\n\nconst jobOperations = {\n  create: getJobOperation(getCheckJobFormatFunction(\"url\"), defineJob),\n  update: getJobOperation(getCheckJobFormatFunction(), defineJob),\n  delete: getJobOperation(getCheckJobFormatFunction(), deleteJob),\n  cancel: getJobOperation(doNotCheck, cancelJob),\n  now: getJobOperation(\n    getCheckJobFormatFunction(false, getDefaultJobForSchedule()),\n    getScheduleJobFunction(scheduleTypes.now)\n  ),\n  once: getJobOperation(\n    getCheckJobFormatFunction(\"interval\", getDefaultJobForSchedule()),\n    getScheduleJobFunction(scheduleTypes.once)\n  ),\n  every: getJobOperation(\n    getCheckJobFormatFunction(\"interval\", getDefaultJobForSchedule()),\n    getScheduleJobFunction(scheduleTypes.every)\n  ),\n};\n\nconst promiseJobOperation = async (\n  job,\n  jobs,\n  agenda,\n  jobAssertion,\n  jobOperation\n) => {\n  job = await jobOperation.check(job);\n  await jobAssertion(job, jobs);\n  return jobOperation.fn(job, jobs, agenda);\n};\n\nexport { promiseJobOperation, jobOperations, jobAssertions, defineJob };\n","import { promisify } from \"util\";\nimport Agenda from \"agenda\";\nimport settings from \"../settings\";\nimport { bootstrapKoaApp } from \"./util\";\nimport {\n  defineJob,\n  jobOperations,\n  jobAssertions,\n  promiseJobOperation,\n} from \"./job\";\n\nconst { app, router } = bootstrapKoaApp();\n\nconst agenda = new Agenda({\n  db: {\n    address: settings.agendaMongoUrl,\n    collection: settings.collection ? settings.collection : undefined,\n  },\n  ...settings.agenda,\n});\n\nconst jobsReady = agenda._ready.then(async () => {\n  const jobs = agenda._mdb.collection(settings.definitions);\n  jobs.toArray = () => {\n    const jobsCursor = jobs.find();\n    return promisify(jobsCursor.toArray).bind(jobsCursor)();\n  };\n\n  await jobs\n    .toArray()\n    .then((jobsArray) =>\n      Promise.all(jobsArray.map((job) => defineJob(job, jobs, agenda)))\n    );\n\n  await agenda.start();\n  return jobs;\n});\n\nconst getJobMiddleware = (\n  jobAssertion,\n  jobOperation,\n  errorCode = 400\n) => async (ctx, next) => {\n  if (settings.appId && ctx.request.headers[\"x-api-key\"] !== settings.appId) {\n    ctx.throw(403, \"Forbidden\");\n  }\n\n  const job = ctx.request.body || {};\n  if (ctx.params.jobName) {\n    job.name = ctx.params.jobName;\n  }\n\n  const jobs = await jobsReady;\n  ctx.body = await promiseJobOperation(\n    job,\n    jobs,\n    agenda,\n    jobAssertion,\n    jobOperation\n  ).catch((error) => ctx.throw(errorCode, error));\n  await next();\n};\n\nconst listJobs = async (ctx, next) => {\n  if (settings.appId && ctx.request.headers[\"x-api-key\"] !== settings.appId) {\n    ctx.throw(403, \"Forbidden\");\n  }\n\n  ctx.body = await jobsReady.then((jobs) => jobs.toArray());\n  await next();\n};\n\nconst createJob = getJobMiddleware(\n  jobAssertions.notExists,\n  jobOperations.create\n);\nconst removeJob = getJobMiddleware(\n  jobAssertions.alreadyExists,\n  jobOperations.delete\n);\nconst updateJob = getJobMiddleware(\n  jobAssertions.alreadyExists,\n  jobOperations.update\n);\nconst runJobOnce = getJobMiddleware(\n  jobAssertions.alreadyExists,\n  jobOperations.once\n);\nconst runJobEvery = getJobMiddleware(\n  jobAssertions.alreadyExists,\n  jobOperations.every\n);\nconst runJobNow = getJobMiddleware(\n  jobAssertions.alreadyExists,\n  jobOperations.now\n);\nconst cancelJobs = getJobMiddleware(\n  jobAssertions.doNotAssert,\n  jobOperations.cancel\n);\n\n// Latest\nrouter.get(\"/api/job\", listJobs);\nrouter.post(\"/api/job\", createJob);\nrouter.del(\"/api/job/:jobName\", removeJob);\nrouter.put(\"/api/job/:jobName\", updateJob);\nrouter.post(\"/api/job/once\", runJobOnce);\nrouter.post(\"/api/job/every\", runJobEvery);\nrouter.post(\"/api/job/now\", runJobNow);\nrouter.post(\"/api/job/cancel\", cancelJobs);\n\nconst redirect = (route, status = 307) => async (ctx, next) => {\n  ctx.status = status;\n  ctx.redirect(route);\n  await next();\n};\n\n// V1\nrouter.get(\"/api/v1/job\", redirect(\"/api/job\"));\nrouter.post(\"/api/v1/job\", redirect(\"/api/job\"));\nrouter.del(\"/api/v1/job/:jobName\", redirect(\"/api/job/:jobName\"));\nrouter.put(\"/api/v1/job/:jobName\", redirect(\"/api/job/:jobName\"));\nrouter.post(\"/api/v1/job/once\", redirect(\"/api/job/once\"));\nrouter.post(\"/api/v1/job/every\", redirect(\"/api/job/every\"));\nrouter.post(\"/api/v1/job/now\", redirect(\"/api/job/now\"));\nrouter.post(\"/api/v1/job/cancel\", redirect(\"/api/job/cancel\"));\n\nexport { app, router, agenda, jobsReady };\nexport default app;\n"],"names":["root","factory","exports","module","define","amd","global","require","bootstrapKoaApp","app","Koa","router","Router","use","logger","ctx","next","catch","error","console","dir","body","String","status","bodyParser","onerror","throw","JSON","stringify","routes","isValidDate","date","Object","prototype","toString","call","isNaN","getTime","repeatPerKey","keys","count","key","fn","buildUrlWithParams","url","params","indexOf","protoDomain","slice","path","value","items","replace","buildUrlWithQuery","query","querystring","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","o","defineProperty","enumerable","get","obj","prop","hasOwnProperty","r","Symbol","toStringTag","getCheckJobFormatFunction","jobProperty","defaultJob","job","name","Error","getAssertFunction","assertOnCount","errorOnName","jobs","countDocuments","then","jobAssertions","alreadyExists","notExists","doNotAssert","defineJob","async","agenda","method","callback","done","attrs","data","uri","options","headers","json","Promise","race","resolve","reject","setTimeout","settings","rp","err","fail","message","result","response","insertOne","updateOne","$set","pickValues","pickProps","reduce","props","scheduleTypes","now","bind","getParams","once","schedule","time","parseInt","interval","Date","every","getScheduleJobFunction","scheduleType","getJobOperation","checkFunction","jobFunction","check","jobOperations","create","update","delete","numRemoved","cancel","remove","Agenda","db","address","collection","jobsReady","_ready","_mdb","toArray","jobsCursor","find","promisify","jobsArray","all","map","start","getJobMiddleware","jobAssertion","jobOperation","errorCode","request","jobName","promiseJobOperation","createJob","removeJob","updateJob","runJobOnce","runJobEvery","runJobNow","cancelJobs","post","del","put","redirect","route"],"sourceRoot":""}